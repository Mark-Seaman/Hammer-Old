#!/usr/bin/python
# Show the index file

# System imports
from sys        import argv,stdin
from os         import system, environ

# Fly imports
from fly        import read_index,display,goto_node, brain_topic, edit_brain_topic, edit_index
from fly        import refresh_index, fly_brain_topic
from readchar   import readchar

help_string = '''
Commands:
  h - help
  q - quit
  i - edit index
  e - edit brain topic
  r - reload the index file
  f - fly to another index
'''


# Perform the action
def action(command):
    #print 'action:',command
    try:
        global node
        cmd = int(command)
        node = goto_node(text,node,cmd)
    except:
        print 'Bad command'

# Read a character and do a command
def readloop(action):
    global text
    global node
    while True:
        ch = readchar ('? ')
        print ch
        if ch=='h':
            print help_string
            continue
        if ch=='i':
            edit_index (node+1)
            print 'Index'
            continue
        if ch=='e':
            text,node = edit_brain_topic(text,node)
            print 'Edit'
            continue
        if ch=='f':
            text,node = fly_brain_topic(text,node)
            print 'Fly'
            continue
        if ch=='r':
            text = refresh_index()
            print 'Refresh'
            continue
        if ch=='q':
            print 'Quit'
            return
        action(ch)

# Print the input as output
def command_loop(action):
    for ch in stdin.read()[:-1]:
        action(ch)

# Setup global state
node = 0
if len(argv)<2:
    fly_file = environ['br']+'/AnalysisJournal'
else:
    fly_file = environ['br']+'/'+argv[1]

text = read_index(fly_file)
display(text,0)

# Process all commands
if len(argv)>2 and argv[2]=='-b':
    command_loop(action)
else:
    readloop(action)
